<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b6e4f" />
  <title>StudyBuddy â€” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</title>

  <style>
    /* ============================
       Styles (Ù…Ù„Ù Ù…Ø¶Ù…Ù‘Ù†)
       Ø§Ù†ØªØ¨Ù‡: Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø¹Ø¯Ù‘Ù„Øª Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø£ÙŠØ¶Ø§Ù‹
       ============================ */
    :root{
      --primary:#0b6e4f;--muted:#777;--bg:#f5f5f5;--card:#fff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Tahoma,Arial,sans-serif;background:var(--bg);color:#222;direction:rtl}
    .topbar{display:flex;align-items:center;justify-content:space-between;background:var(--primary);color:#fff;padding:12px 16px;position:sticky;top:0;z-index:50}
    .brand{font-size:22px;font-weight:700}
    .icon-btn{background:none;border:0;color:#fff;font-size:20px;cursor:pointer;padding:6px}
    .main{padding:18px 14px 80px}
    .side{position:fixed;top:0;right:0;height:100%;width:260px;padding:16px;background:var(--card);border-left:1px solid #e9e9e9;box-shadow:-8px 0 18px rgba(0,0,0,0.05);transform:translateX(110%);transition:transform .2s ease;z-index:60}
    .side.hidden{transform:translateX(110%)}
    .side ul{list-style:none;padding:0;margin:0}
    .side li{padding:10px;border-radius:6px;cursor:pointer}
    .side li.active,.side li:hover{background:var(--primary);color:#fff}
    .side-footer{font-size:12px;color:var(--muted);margin-top:18px;text-align:center}
    .card{background:var(--card);border-radius:10px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
    .summary-grid{display:flex;justify-content:space-around;gap:14px;text-align:center}
    .summary-item .num{font-size:28px;color:var(--primary);font-weight:700}
    .list{list-style:disc;padding-inline-start:24px}
    .books-list a{color:#1a0dab;text-decoration:underline}
    .small{background:#eee;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
    .primary{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:6px;cursor:pointer}
    textarea{width:100%;min-height:100px;padding:10px;border-radius:6px;border:1px solid #ddd;font-family:inherit}
    .flashcard{min-height:140px;width:100%;border-radius:8px;background:#fafafa;border:1px solid #eee;padding:18px;display:flex;align-items:center;justify-content:center;font-size:18px;text-align:center}
    .flash-controls button{margin:0 6px}
    .timer-display{font-size:48px;font-weight:700;margin:10px 0}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .bottombar{text-align:center;padding:14px 10px;color:var(--muted);font-size:13px}
    @media (min-width:900px){
      .main{max-width:980px;margin:18px auto;padding:18px}
      .side{transform:translateX(0);right:16px}
      .side.hidden{transform:translateX(0)}
    }
  </style>
</head>
<body>
  <div id="app">
    <header class="topbar">
      <button id="menuBtn" class="icon-btn" aria-label="Ù‚Ø§Ø¦Ù…Ø©">â˜°</button>
      <div class="brand">StudyBuddy ğŸ“š</div>
      <button id="addBtn" class="icon-btn" title="Ø£Ø¶Ù">ï¼‹</button>
    </header>

    <nav id="side" class="side hidden" aria-hidden="true">
      <ul>
        <li data-view="dashboard" class="active">Ø§Ù„Ù…Ù„Ø®Øµ</li>
        <li data-view="books">Ø§Ù„Ù…Ù„Ø§Ø²Ù… ğŸ“</li>
        <li data-view="subjects">Ø§Ù„Ù…ÙˆØ§Ø¯ ğŸ“š</li>
        <li data-view="tasks">Ø§Ù„Ù…Ù‡Ø§Ù… âœ…</li>
        <li data-view="flashcards">Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© ğŸƒ</li>
        <li data-view="timer">Ø§Ù„Ù…Ø¤Ù‚Øª â±</li>
        <li data-view="notes">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ğŸ“</li>
        <li data-view="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âš™ï¸</li>
      </ul>
      <div class="side-footer">StudyBuddy â€¢ Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„</div>
    </nav>

    <main id="main" class="main">
      <!-- Dashboard -->
      <section id="dashboard" class="view card">
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h2>
        <p>Ù‡Ø°Ø§ Ù…Ù„Ø®Øµ Ø¯Ø±Ø§Ø³ØªÙƒ â€” Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯ØŒ Ø§Ù„Ù…Ù‡Ø§Ù…ØŒ ÙˆØ¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©.</p>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="num" id="countSubjects">0</div>
            <div>Ø§Ù„Ù…ÙˆØ§Ø¯</div>
          </div>
          <div class="summary-item">
            <div class="num" id="countTasks">0</div>
            <div>Ø§Ù„Ù…Ù‡Ø§Ù…</div>
          </div>
          <div class="summary-item">
            <div class="num" id="countFlash">0</div>
            <div>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</div>
          </div>
        </div>
      </section>

      <!-- Books -->
      <section id="books" class="view hidden card">
        <h2>Ø§Ù„Ù…Ù„Ø§Ø²Ù… ğŸ“</h2>
        <p>Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø²Ù…Ø© (PDF). Ø¶Ø¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù€ PDF Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ <code>/pdfs/</code> Ø£Ùˆ Ø­Ø¯Ù‘Ø« Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡.</p>
        <ul id="booksList" class="list books-list"></ul>
        <div class="hint">Ø¥Ù† Ù„Ù… ØªØ±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø³ÙŠØ¸Ù‡Ø± Ø®Ø·Ø£ ÙØªØ­ â€” Ø¹Ø¯Ù‘Ù„ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙƒØªØ¨ Ø£Ùˆ Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ø³Ù…ÙŠØ§Ù‹.</div>
      </section>

      <!-- Subjects -->
      <section id="subjects" class="view hidden card">
        <h2>Ø§Ù„Ù…ÙˆØ§Ø¯</h2>
        <button id="addSubjectBtn" class="small">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
        <ul id="subjectsList" class="list"></ul>
      </section>

      <!-- Tasks -->
      <section id="tasks" class="view hidden card">
        <h2>Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
        <button id="addTaskBtn" class="small">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button>
        <ul id="tasksList" class="list"></ul>
      </section>

      <!-- Flashcards -->
      <section id="flashcards" class="view hidden card">
        <h2>Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</h2>
        <div class="flashcard" id="flashCard">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª â€” Ø£Ø¶Ù Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø¨Ø¯Ø¡</div>
        <div class="row" style="margin-top:10px">
          <button id="prevFlash" class="small">â—€</button>
          <button id="flipFlash" class="small">Ù‚Ù„Ø¨</button>
          <button id="nextFlash" class="small">â–¶</button>
          <button id="addFlash" class="small">Ø£Ø¶Ù Ø¨Ø·Ø§Ù‚Ø©</button>
        </div>
      </section>

      <!-- Timer -->
      <section id="timer" class="view hidden card">
        <h2>Ù…Ø¤Ù‚Øª Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ</h2>
        <div class="timer-display" id="timerDisplay">25:00</div>
        <div class="row">
          <label>Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯Ù‚Ø§Ø¦Ù‚): <input id="sessionMinutes" type="number" min="1" value="25" style="width:90px;margin-right:8px"></label>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="startTimer" class="primary">Ø§Ø¨Ø¯Ø£</button>
          <button id="pauseTimer" class="small">Ø¥ÙŠÙ‚Ø§Ù</button>
          <button id="resetTimer" class="small">Ø¥Ø¹Ø§Ø¯Ø©</button>
        </div>
      </section>

      <!-- Notes -->
      <section id="notes" class="view hidden card">
        <h2>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
        <textarea id="noteText" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ù‡Ù†Ø§..."></textarea>
        <div class="row" style="margin-top:8px">
          <button id="saveNote" class="primary">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
          <button id="clearNotes" class="small">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </div>
        <ul id="notesList" class="list" style="margin-top:12px"></ul>
      </section>

      <!-- Settings -->
      <section id="settings" class="view hidden card">
        <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
        <div class="row" style="margin-bottom:10px">
          <label><input type="checkbox" id="toggleDark"> ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ†</label>
        </div>
        <div class="row">
          <button id="exportData" class="small">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
          <button id="importData" class="small">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <input id="fileInput" type="file" accept=".json" style="display:none">
        </div>
        <div class="hint" style="margin-top:8px">Ø§Ù„ØªØµØ¯ÙŠØ± ÙŠØ­ÙØ¸ Ù…Ù„Ù JSON ØªØ­Ù…Ù„Ù‡. Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙŠØ¶ÙŠÙ/ÙŠØ­Ø¯Ù‘Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù JSON Ù…Ø´Ø§Ø¨Ù‡.</div>
      </section>
    </main>

    <footer class="bottombar">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© StudyBuddy 2025</footer>
  </div>

  <script>
  /* =========================
     IndexedDB wrapper (STUDYDB)
     ========================= */
  const STUDYDB = (() => {
    const dbName = 'studybuddyDB';
    const version = 1;
    let db = null;

    function openDB() {
      return new Promise((resolve, reject) => {
        try {
          const req = indexedDB.open(dbName, version);
          req.onupgradeneeded = e => {
            db = e.target.result;
            if(!db.objectStoreNames.contains('subjects')) db.createObjectStore('subjects',{keyPath:'id'});
            if(!db.objectStoreNames.contains('tasks')) db.createObjectStore('tasks',{keyPath:'id'});
            if(!db.objectStoreNames.contains('flash')) db.createObjectStore('flash',{keyPath:'id'});
            if(!db.objectStoreNames.contains('notes')) db.createObjectStore('notes',{keyPath:'id'});
          };
          req.onsuccess = e => { db = e.target.result; resolve(); };
          req.onerror = e => reject(e);
        } catch(err) { reject(err); }
      });
    }

    function tx(store, mode='readonly'){
      if(!db) throw new Error('DB not opened');
      return db.transaction(store, mode).objectStore(store);
    }

    function getAll(store){
      return new Promise((resolve, reject) => {
        try {
          const r = tx(store).getAll();
          r.onsuccess = () => resolve(r.result || []);
          r.onerror = () => reject(r.error || new Error('getAll error'));
        } catch(err) { reject(err); }
      });
    }

    function put(store, val){
      return new Promise((resolve, reject) => {
        try {
          const r = tx(store, 'readwrite').put(val);
          r.onsuccess = () => resolve(val);
          r.onerror = () => reject(r.error || new Error('put error'));
        } catch(err) { reject(err); }
      });
    }

    function del(store, key){
      return new Promise((resolve, reject) => {
        try {
          const r = tx(store, 'readwrite').delete(key);
          r.onsuccess = () => resolve();
          r.onerror = () => reject(r.error || new Error('delete error'));
        } catch(err) { reject(err); }
      });
    }

    return { openDB, getAll, put, del };
  })();

  /* =========================
     Main App
     ========================= */
  const App = (() => {
    // helpers
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const escapeHtml = s => { if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[c])); };

    // state
    const state = { subjects: [], tasks: [], flash: [], notes: [] };
    let timerInterval = null;
    let timerSeconds = 25*60;
    let flashIndex = 0;
    let flashShowingBack = false;

    // UI refs
    const menuBtn = $('#menuBtn'), side = $('#side'), addBtn = $('#addBtn');
    const views = $$('.view');
    const countSubjects = $('#countSubjects'), countTasks = $('#countTasks'), countFlash = $('#countFlash');
    const subjectsList = $('#subjectsList'), tasksList = $('#tasksList'), notesList = $('#notesList'), booksList = $('#booksList');
    const flashCard = $('#flashCard'), prevFlash = $('#prevFlash'), nextFlash = $('#nextFlash'), flipFlash = $('#flipFlash'), addFlash = $('#addFlash');
    const timerDisplay = $('#timerDisplay'), startTimer = $('#startTimer'), pauseTimer = $('#pauseTimer'), resetTimer = $('#resetTimer'), sessionMinutes = $('#sessionMinutes');
    const noteText = $('#noteText'), saveNote = $('#saveNote'), clearNotes = $('#clearNotes');
    const addSubjectBtn = $('#addSubjectBtn'), addTaskBtn = $('#addTaskBtn');
    const exportBtn = $('#exportData'), importBtn = $('#importData'), fileInput = $('#fileInput'), toggleDark = $('#toggleDark');

    // default books (Ø±ÙˆØ§Ø¨Ø· Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ pdfs/)
    const books = [
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', file: 'pdfs/math.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡', file: 'pdfs/physics.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡', file: 'pdfs/chemistry.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø¬Ø²Ø¡1)', file: 'pdfs/arabic1.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø¬Ø²Ø¡2)', file: 'pdfs/arabic2.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ', file: 'pdfs/english.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ø§Ø³Ù„Ø§Ù…ÙŠØ©', file: 'pdfs/islamic.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ø§Ø­ÙŠØ§Ø¡', file: 'pdfs/biology.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª', file: 'pdfs/social.pdf' }
    ];

    // init
    async function init(){
      try {
        await STUDYDB.openDB();
      } catch(err) {
        console.warn('IndexedDB not available, falling back to localStorage', err);
      }
      await loadAll();
      seedSubjectsIfEmpty();
      bind();
      renderBooks();
      updateCounts();
      showView('dashboard');
      updateTimerDisplay();
    }

    // load from DB (with fallback)
    async function loadAll(){
      try {
        state.subjects = await STUDYDB.getAll('subjects') || [];
        state.tasks = await STUDYDB.getAll('tasks') || [];
        state.flash = await STUDYDB.getAll('flash') || [];
        state.notes = await STUDYDB.getAll('notes') || [];
      } catch(e){
        // fallback localStorage
        const raw = localStorage.getItem('studybuddy_fallback');
        if(raw) {
          try {
            const obj = JSON.parse(raw);
            state.subjects = obj.subjects || [];
            state.tasks = obj.tasks || [];
            state.flash = obj.flash || [];
            state.notes = obj.notes || [];
          } catch(err){ console.error(err); }
        }
      }
      renderAll();
    }

    // save fallback to localStorage (if IndexedDB not available)
    function saveFallback(){
      try {
        localStorage.setItem('studybuddy_fallback', JSON.stringify(state));
      } catch(e){}
    }

    // seed common subjects if empty
    async function seedSubjectsIfEmpty(){
      if(state.subjects.length === 0){
        const samples = ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡','Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡','Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©','Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ','Ø§Ù„Ø§Ø­ÙŠØ§Ø¡','Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª','Ø§Ù„Ø§Ø³Ù„Ø§Ù…ÙŠØ©'];
        for(let i=0;i<samples.length;i++){
          const id = 'sub-' + Date.now() + '-' + i;
          const obj = { id, title: samples[i], desc: '' };
          try { await STUDYDB.put('subjects', obj); } catch(e){ /* fallback handled later */ }
          state.subjects.push(obj);
        }
        saveFallback();
        renderSubjects();
        updateCounts();
      }
    }

    // binding UI events
    function bind(){
      menuBtn.addEventListener('click', ()=> side.classList.toggle('hidden'));
      $$('.side li').forEach(li => li.addEventListener('click', e=>{
        const v = e.currentTarget.dataset.view;
        showView(v);
        $$('.side li').forEach(x=>x.classList.remove('active'));
        e.currentTarget.classList.add('active');
      }));

      addBtn.addEventListener('click', ()=> {
        // quick action: open subjects view to add
        showView('subjects');
        $$('.side li').forEach(x=>x.classList.remove('active'));
        document.querySelector('[data-view="subjects"]').classList.add('active');
      });

      addSubjectBtn.addEventListener('click', onAddSubject);
      addTaskBtn.addEventListener('click', onAddTask);

      startTimer.addEventListener('click', startPomodoro);
      pauseTimer.addEventListener('click', pausePomodoro);
      resetTimer.addEventListener('click', ()=> {
        stopPomodoro();
        const m = Math.max(1, parseInt(sessionMinutes.value || 25));
        timerSeconds = m * 60;
        updateTimerDisplay();
      });
      sessionMinutes.addEventListener('change', ()=> {
        const m = Math.max(1, parseInt(sessionMinutes.value || 25));
        timerSeconds = m * 60;
        updateTimerDisplay();
      });

      prevFlash.addEventListener('click', ()=> {
        if(state.flash.length===0) return;
        flashIndex = (flashIndex - 1 + state.flash.length) % state.flash.length;
        flashShowingBack = false;
        renderFlash();
      });
      nextFlash.addEventListener('click', ()=> {
        if(state.flash.length===0) return;
        flashIndex = (flashIndex + 1) % state.flash.length;
        flashShowingBack = false;
        renderFlash();
      });
      flipFlash.addEventListener('click', ()=> { flashShowingBack = !flashShowingBack; renderFlash(); });
      addFlash.addEventListener('click', onAddFlash);

      saveNote.addEventListener('click', async ()=>{
        const text = noteText.value.trim();
        if(!text) return alert('Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
        const id = 'note-'+Date.now();
        const obj = { id, text, created: Date.now() };
        try { await STUDYDB.put('notes', obj); } catch(e){}
        state.notes.push(obj);
        noteText.value='';
        renderNotes();
        saveFallback();
      });
      clearNotes.addEventListener('click', async ()=>{
        if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŸ')) return;
        for(const n of state.notes){
          try { await STUDYDB.del('notes', n.id); } catch(e){}
        }
        state.notes = [];
        renderNotes();
        saveFallback();
      });

      exportBtn.addEventListener('click', exportData);
      importBtn.addEventListener('click', ()=> fileInput.click());
      fileInput.addEventListener('change', importData);

      toggleDark.addEventListener('change', ()=> document.documentElement.classList.toggle('dark', toggleDark.checked));
    }

    // view switch
    function showView(id){
      views.forEach(v=> v.id === id ? v.classList.remove('hidden') : v.classList.add('hidden'));
      side.classList.add('hidden');
    }

    // Subjects
    async function onAddSubject(){
      const title = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:');
      if(!title) return;
      const id = 'sub-'+Date.now();
      const obj = { id, title: title.trim(), desc: '' };
      try { await STUDYDB.put('subjects', obj); } catch(e){}
      state.subjects.push(obj);
      renderSubjects();
      updateCounts();
      saveFallback();
    }

    function renderSubjects(){
      subjectsList.innerHTML = '';
      if(state.subjects.length===0){ subjectsList.innerHTML = '<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ø¨Ø¹Ø¯</li>'; return; }
      state.subjects.forEach(s=>{
        const li = document.createElement('li');
        li.innerHTML = `<strong>${escapeHtml(s.title)}</strong> <button class="small del-sub" data-id="${s.id}" style="margin-right:8px">Ø­Ø°Ù</button>`;
        subjectsList.appendChild(li);
      });
      $$('.del-sub').forEach(b => b.addEventListener('click', async e=>{
        const id = e.currentTarget.dataset.id;
        if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) return;
        try { await STUDYDB.del('subjects', id); } catch(e){}
        state.subjects = state.subjects.filter(x=>x.id !== id);
        renderSubjects();
        updateCounts();
        saveFallback();
      }));
    }

    // Tasks
    async function onAddTask(){
      const title = prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©:');
      if(!title) return;
      const subject = prompt('Ø§Ù„Ù…Ø§Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):') || '';
      const due = prompt('ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø¨ØµÙŠØºØ© YYYY-MM-DDTHH:MM (Ù…Ø«Ø§Ù„: 2025-09-30T14:30) â€” Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ†') || null;
      const id = 'task-'+Date.now();
      const obj = { id, title: title.trim(), subject: subject.trim(), due: due || null, done: false };
      try { await STUDYDB.put('tasks', obj); } catch(e){}
      state.tasks.push(obj);
      renderTasks();
      updateCounts();
      saveFallback();
    }

    function renderTasks(){
      tasksList.innerHTML = '';
      if(state.tasks.length===0){ tasksList.innerHTML = '<li>Ù„Ø§ Ù…Ù‡Ø§Ù… Ø¨Ø¹Ø¯</li>'; return; }
      state.tasks.forEach(t=>{
        const dueText = t.due ? new Date(t.due).toLocaleString() : 'Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¹Ø¯';
        const li = document.createElement('li');
        li.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div><strong>${escapeHtml(t.title)}</strong></div>
            <div style="font-size:13px;color:var(--muted)">${escapeHtml(t.subject||'')} â€¢ ${escapeHtml(dueText)}</div>
          </div>
          <div>
            <button class="small doneBtn" data-id="${t.id}">${t.done ? 'âœ“' : 'â—‹'}</button>
            <button class="small delTask" data-id="${t.id}">Ø­Ø°Ù</button>
          </div>
        </div>`;
        tasksList.appendChild(li);
      });
      $$('.doneBtn').forEach(b => b.addEventListener('click', async e=>{
        const id = e.currentTarget.dataset.id;
        const t = state.tasks.find(x=>x.id===id); if(!t) return;
        t.done = !t.done;
        try { await STUDYDB.put('tasks', t); } catch(e){}
        renderTasks(); saveFallback();
      }));
      $$('.delTask').forEach(b => b.addEventListener('click', async e=>{
        const id = e.currentTarget.dataset.id;
        if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
        try { await STUDYDB.del('tasks', id); } catch(e){}
        state.tasks = state.tasks.filter(x=>x.id!==id);
        renderTasks(); updateCounts(); saveFallback();
      }));
    }

    // Flashcards
    async function onAddFlash(){
      const front = prompt('Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø§Ù„Ø³Ø¤Ø§Ù„):');
      if(!front) return;
      const back = prompt('Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©):') || '';
      const id = 'flash-'+Date.now();
      const obj = { id, front: front.trim(), back: back.trim() };
      try { await STUDYDB.put('flash', obj); } catch(e){}
      state.flash.push(obj);
      renderFlash(); updateCounts(); saveFallback();
    }

    function renderFlash(){
      if(state.flash.length===0){ flashCard.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª â€” Ø£Ø¶Ù Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø¨Ø¯Ø¡'; return; }
      if(flashIndex >= state.flash.length) flashIndex = 0;
      const card = state.flash[flashIndex];
      flashCard.textContent = flashShowingBack ? card.back : card.front;
    }

    // Notes
    function renderNotes(){
      notesList.innerHTML = '';
      if(state.notes.length===0){ notesList.innerHTML = '<li>Ù„Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</li>'; return; }
      // show newest first
      state.notes.slice().reverse().forEach(n=>{
        const li = document.createElement('li');
        li.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:14px">${escapeHtml(n.text)}</div>
            <div style="font-size:12px;color:var(--muted)">${new Date(n.created).toLocaleString()}</div>
          </div>
          <div><button class="small delNote" data-id="${n.id}">Ø­Ø°Ù</button></div>
        </div>`;
        notesList.appendChild(li);
      });
      $$('.delNote').forEach(b => b.addEventListener('click', async e=>{
        const id = e.currentTarget.dataset.id;
        if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ')) return;
        try { await STUDYDB.del('notes', id); } catch(e){}
        state.notes = state.notes.filter(x=>x.id!==id);
        renderNotes(); saveFallback();
      }));
    }

    // Books
    function renderBooks(){
      booksList.innerHTML = '';
      books.forEach(bk=>{
        const li = document.createElement('li');
        // Ø±Ø§Ø¨Ø· Ù…Ù„Ù PDF Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ pdfs/ â€” ØªØ£ÙƒØ¯ ØªØ±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
        li.innerHTML = `<a href="${bk.file}" target="_blank" rel="noopener">${escapeHtml(bk.name)}</a>`;
        booksList.appendChild(li);
      });
    }

    // Timer
    function updateTimerDisplay(){
      const m = Math.floor(timerSeconds/60).toString().padStart(2,'0');
      const s = (timerSeconds%60).toString().padStart(2,'0');
      timerDisplay.textContent = `${m}:${s}`;
    }
    function startPomodoro(){
      if(timerInterval) return;
      const minutes = Math.max(1, parseInt(sessionMinutes.value || 25));
      timerSeconds = minutes * 60;
      updateTimerDisplay();
      timerInterval = setInterval(()=>{
        if(timerSeconds <= 0){ stopPomodoro(); notifyFinish(); return; }
        timerSeconds--; updateTimerDisplay();
      }, 1000);
    }
    function pausePomodoro(){ stopPomodoro(); }
    function stopPomodoro(){ clearInterval(timerInterval); timerInterval = null; }
    function notifyFinish(){
      try {
        if('Notification' in window && Notification.permission === 'granted'){
          new Notification('StudyBuddy', { body: 'Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©' });
        } else {
          alert('Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©');
        }
      } catch(e){ alert('Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©'); }
    }

    // Export / Import
    async function exportData(){
      try {
        const payload = {
          subjects: await STUDYDB.getAll('subjects').catch(()=> state.subjects),
          tasks: await STUDYDB.getAll('tasks').catch(()=> state.tasks),
          flash: await STUDYDB.getAll('flash').catch(()=> state.flash),
          notes: await STUDYDB.getAll('notes').catch(()=> state.notes)
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'studybuddy-export.json';
        a.click();
        URL.revokeObjectURL(url);
      } catch(e){ alert('ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±'); console.error(e); }
    }

    async function importData(){
      const file = fileInput.files && fileInput.files[0];
      if(!file) return;
      try {
        const txt = await file.text();
        const data = JSON.parse(txt);
        if(Array.isArray(data.subjects)){
          for(const s of data.subjects) try{ await STUDYDB.put('subjects', s); } catch(e){};
        }
        if(Array.isArray(data.tasks)){
          for(const t of data.tasks) try{ await STUDYDB.put('tasks', t); } catch(e){};
        }
        if(Array.isArray(data.flash)){
          for(const f of data.flash) try{ await STUDYDB.put('flash', f); } catch(e){};
        }
        if(Array.isArray(data.notes)){
          for(const n of data.notes) try{ await STUDYDB.put('notes', n); } catch(e){};
        }
        await loadAll();
        alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      } catch(e){ alert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù'); console.error(e); }
    }

    // update counts & render all
    function updateCounts(){
      countSubjects.textContent = state.subjects.length;
      countTasks.textContent = state.tasks.length;
      countFlash.textContent = state.flash.length;
    }
    function renderAll(){
      renderSubjects(); renderTasks(); renderFlash(); renderNotes(); updateCounts();
    }

    // render helpers for local state (used after load)
    function renderSubjects(){ /* uses state */ subjectsList && (subjectsList.innerHTML = ''); subjectsList && (state.subjects.length===0 ? (subjectsList.innerHTML = '<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ø¨Ø¹Ø¯</li>') : state.subjects.forEach(s => {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${escapeHtml(s.title)}</strong> <button class="small del-sub" data-id="${s.id}" style="margin-right:8px">Ø­Ø°Ù</button>`;
      subjectsList.appendChild(li);
    })); setTimeout(()=>{ $$('.del-sub').forEach(b => b.addEventListener('click', async e=>{ const id = e.currentTarget.dataset.id; if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) return; try{ await STUDYDB.del('subjects', id);}catch(e){} state.subjects = state.subjects.filter(x=>x.id!==id); renderSubjects(); updateCounts();}), 0) }

    function renderTasks(){ tasksList && (tasksList.innerHTML = ''); if(tasksList){ if(state.tasks.length===0){ tasksList.innerHTML = '<li>Ù„Ø§ Ù…Ù‡Ø§Ù… Ø¨Ø¹Ø¯</li>'; return; } state.tasks.forEach(t => {
      const dueText = t.due ? new Date(t.due).toLocaleString() : 'Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¹Ø¯';
      const li = document.createElement('li');
      li.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div><strong>${escapeHtml(t.title)}</strong></div>
          <div style="font-size:13px;color:var(--muted)">${escapeHtml(t.subject||'')} â€¢ ${escapeHtml(dueText)}</div>
        </div>
        <div>
          <button class="small doneBtn" data-id="${t.id}">${t.done ? 'âœ“' : 'â—‹'}</button>
          <button class="small delTask" data-id="${t.id}">Ø­Ø°Ù</button>
        </div>
      </div>`;
      tasksList.appendChild(li);
    }); setTimeout(()=>{ $$('.doneBtn').forEach(b => b.addEventListener('click', async e=>{ const id = e.currentTarget.dataset.id; const t = state.tasks.find(x=>x.id===id); if(!t) return; t.done = !t.done; try{ await STUDYDB.put('tasks', t);}catch(e){} renderTasks(); saveFallback(); })); $$('.delTask').forEach(b => b.addEventListener('click', async e=>{ const id = e.currentTarget.dataset.id; if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return; try{ await STUDYDB.del('tasks', id);}catch(e){} state.tasks = state.tasks.filter(x=>x.id!==id); renderTasks(); updateCounts(); saveFallback(); })); },0) } }

    function renderFlash(){ if(!flashCard) return; if(state.flash.length===0){ flashCard.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª â€” Ø£Ø¶Ù Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø¨Ø¯Ø¡'; return; } if(flashIndex >= state.flash.length) flashIndex = 0; const card = state.flash[flashIndex]; flashCard.textContent = flashShowingBack ? card.back : card.front; }

    function renderNotes(){ notesList && (notesList.innerHTML = ''); if(!notesList) return; if(state.notes.length===0){ notesList.innerHTML = '<li>Ù„Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</li>'; return; } state.notes.slice().reverse().forEach(n=>{ const li = document.createElement('li'); li.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:14px">${escapeHtml(n.text)}</div><div style="font-size:12px;color:var(--muted)">${new Date(n.created).toLocaleString()}</div></div><div><button class="small delNote" data-id="${n.id}">Ø­Ø°Ù</button></div></div>`; notesList.appendChild(li); }); setTimeout(()=>{ $$('.delNote').forEach(b => b.addEventListener('click', async e=>{ const id = e.currentTarget.dataset.id; if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ')) return; try{ await STUDYDB.del('notes', id);}catch(e){} state.notes = state.notes.filter(x=>x.id!==id); renderNotes(); saveFallback(); })); },0) }

    // expose init
    return { init };
  })();

  // start app on DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    App.init().catch(e => {
      console.error('App init error', e);
      alert('ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: ' + (e && e.message ? e.message : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
    });
  });
  </script>
</body>
</html>
