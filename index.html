<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StudyBuddy â€” Ø§Ù„Ù…Ù„Ø§Ø²Ù…ØŒ Ø§Ù„Ù…Ø¤Ù‚ØªØŒ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</title>

  <style>
    :root{
      --primary:#0b6e4f; --muted:#6f7a80; --card:#fff; --bg:#f6f7f8; --fast:140ms;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Tahoma,Arial,sans-serif;background:var(--bg);color:#222;direction:rtl;scroll-behavior:smooth}
    a{color:var(--primary);text-decoration:none}
    a:hover{text-decoration:underline}
    /* Topbar */
    .topbar{display:flex;align-items:center;justify-content:space-between;background:var(--primary);color:#fff;padding:12px 14px;position:sticky;top:0;z-index:120}
    .brand{font-weight:700;font-size:18px}
    .icon-btn{background:none;border:0;color:#fff;font-size:20px;cursor:pointer;padding:6px}
    /* Layout */
    .layout{display:flex;min-height:calc(100vh - 56px)}
    .side{width:260px;background:var(--card);border-left:1px solid #e8e8e8;padding:12px;transition:transform var(--fast) ease;box-shadow:-6px 0 18px rgba(0,0,0,0.03)}
    .side.hidden{transform:translateX(110%)}
    .side ul{list-style:none;padding:0;margin:0}
    .side li{padding:10px;border-radius:8px;cursor:pointer;margin-bottom:8px}
    .side li.active,.side li:hover{background:var(--primary);color:#fff}
    .side .small{font-size:12px;color:var(--muted);text-align:center;margin-top:10px}
    main{flex:1;padding:18px;max-width:1100px;margin:0 auto}
    .card{background:var(--card);border-radius:10px;padding:16px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
    .headline{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .muted{color:var(--muted);font-size:13px}
    /* Materials */
    .material-list{list-style:none;padding:0;margin:12px 0;display:flex;flex-direction:column;gap:10px}
    .material-item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:#fafafa;border:1px solid #eee}
    .material-left{display:flex;gap:8px;align-items:center;flex:1}
    .material-left input{border:1px solid #ddd;padding:6px 8px;border-radius:6px;font-size:14px;width:220px}
    .material-url{font-size:13px;color:var(--muted);max-width:360px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .material-actions{display:flex;gap:8px;align-items:center}
    .status{font-size:13px;color:var(--muted);min-width:110px;text-align:left}
    .small-btn{padding:6px 8px;border-radius:6px;border:0;cursor:pointer;background:#f0f0f0;color:#222}
    /* Timer */
    .timer-display{font-size:44px;font-weight:700;text-align:center;margin:16px 0}
    .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .btn{border:0;padding:8px 12px;border-radius:8px;cursor:pointer;background:var(--primary);color:#fff}
    .btn.ghost{background:#f0f0f0;color:#222}
    input[type="number"]{width:96px;padding:8px;border-radius:6px;border:1px solid #ddd;text-align:center;}
    /* Notes */
    textarea{width:100%;min-height:120px;padding:10px;border-radius:8px;border:1px solid #ddd;font-family:inherit}
    .notes-list-item{background:#fff;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid #eee}
    footer{padding:12px;text-align:center;color:var(--muted);font-size:13px}
    @media (max-width:900px){
      .layout{flex-direction:column}
      .side{position:fixed;top:56px;right:0;height:calc(100% - 56px);z-index:115}
      .side.hidden{transform:translateX(110%)}
      .material-left input{width:140px}
      .material-url{max-width:160px}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">StudyBuddy ğŸ“š</div>
    <div>
      <button id="menuBtn" class="icon-btn" aria-label="Ù‚Ø§Ø¦Ù…Ø©">â˜°</button>
    </div>
  </header>

  <div class="layout">
    <aside id="side" class="side hidden" aria-hidden="true">
      <ul>
        <li data-view="home" class="active">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</li>
        <li data-view="materials">ğŸ“š Ø§Ù„Ù…Ù„Ø§Ø²Ù…</li>
        <li data-view="timer">â± Ø§Ù„Ù…Ø¤Ù‚Øª</li>
        <li data-view="notes">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</li>
      </ul>
      <div class="small">StudyBuddy â€” ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„</div>
    </aside>

    <main>
      <!-- Home -->
      <section id="home" class="card view active">
        <div class="headline">
          <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ StudyBuddy</h2>
          <div class="muted">Ø§Ù†ØªÙ‚Ù„ Ø¨Ø³Ø±Ø¹Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â€” Ø§Ø¶Ù Ø£Ùˆ Ø¹Ø¯Ù„ Ø§Ù„Ù…Ù„Ø§Ø²Ù… Ø«Ù… Ø§Ø­ÙØ¸</div>
        </div>
        <p class="muted" style="margin-top:10px">- Ø£Ø±Ø³Ù„ Ù„ÙŠ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ù„Ø§Ø²Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ùˆ ØªØ±ÙŠØ¯ Ø£Ø¶ÙŠÙÙ‡Ø§. <br>- ÙƒÙ„ Ù…Ù„Ø²Ù…Ø© ÙŠÙ…ÙƒÙ†Ùƒ ÙØªØ­Ù‡Ø§ Ø£Ùˆ ØªØ­Ù…ÙŠÙ„Ù‡Ø§ (Google Drive ÙŠØ­ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø±Ø§Ø¨Ø· ØªÙ†Ø²ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ†Ø·Ø¨Ù‚).</p>
        <div style="margin-top:12px">
          <button class="btn" onclick="showView('materials')">ğŸ“š Ø§Ù„Ù…Ù„Ø§Ø²Ù…</button>
          <button class="btn" onclick="showView('timer')">â± Ø§Ù„Ù…Ø¤Ù‚Øª</button>
          <button class="btn" onclick="showView('notes')">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
        </div>
      </section>

      <!-- Materials -->
      <section id="materials" class="card view" style="display:none">
        <div class="headline">
          <h2>Ø§Ù„Ù…Ù„Ø§Ø²Ù… ÙˆØ§Ù„Ù…ÙˆØ§Ø¯</h2>
          <div class="muted">Ø§Ø¶Ù/Ø­Ø±Ø± Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ù„Ø§Ø²Ù… â€” Ø§Ø¶ØºØ· "Ø§Ø®ØªØ¨Ø§Ø±" Ù„Ù„ØªØ£ÙƒØ¯ Ø£Ùˆ "ÙØªØ­" Ù„ÙØªØ­/ØªØ­Ù…ÙŠÙ„</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <input id="newLabel" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ø²Ù…Ø© (Ù…Ø«Ø§Ù„: Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª)" style="padding:8px;border-radius:6px;border:1px solid #ddd;width:280px">
          <input id="newURL" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ø²Ù…Ø© (Google Drive Ø£Ùˆ Ø±Ø§Ø¨Ø· PDF Ù…Ø¨Ø§Ø´Ø±)" style="padding:8px;border-radius:6px;border:1px solid #ddd;flex:1">
          <button id="addMaterialBtn" class="btn">â• Ø£Ø¶Ù Ù…Ù„Ø²Ù…Ø©</button>
        </div>

        <ul id="materialsList" class="material-list"></ul>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="saveMaterialsMeta" class="btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø²Ù…</button>
          <button id="reloadStatus" class="btn ghost">ğŸ”„ ÙØ­Øµ</button>
          <button id="clearMaterials" class="btn ghost">ğŸ—‘ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ù„Ø§Ø²Ù…</button>
        </div>
        <div class="muted" style="margin-top:10px">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø±ÙˆØ§Ø¨Ø· Google Drive Ø³ØªÙØ­ÙˆÙ‘Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø±Ø§Ø¨Ø· ØªÙ†Ø²ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± (Ø¥Ù† Ø£Ù…ÙƒÙ†). Ø¥Ø°Ø§ Ø¸Ù‡Ø± "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·" ÙØ§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ø®Ø§Ø¯Ù… Ù‚Ø¯ ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙØ­Øµ Ø£Ùˆ Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ Ù…ØªØ§Ø­Ø§Ù‹ Ù„Ù„Ø¹Ø±Ø¶.</div>
      </section>

      <!-- Timer -->
      <section id="timer" class="card view" style="display:none">
        <div class="headline"><h2>Ù…Ø¤Ù‚Øª Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ</h2><div class="muted">Ø´ØºÙ‘Ù„ ÙˆØ§Ø³ØªØ¹Ù…Ù„ +/âˆ’ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø³Ø±Ø¹Ø©</div></div>
        <div class="timer-display" id="timerDisplay">25:00</div>

        <div class="controls">
          <button class="btn" id="startBtn">Ø§Ø¨Ø¯Ø£</button>
          <button class="btn ghost" id="pauseBtn">Ø¥ÙŠÙ‚Ø§Ù</button>
          <button class="btn ghost" id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
        </div>

        <div class="controls" style="margin-top:10px">
          <button class="btn ghost" id="incBtn">â• Ø¯Ù‚ÙŠÙ‚Ø©</button>
          <button class="btn ghost" id="decBtn">â– Ø¯Ù‚ÙŠÙ‚Ø©</button>
          <label style="display:flex;align-items:center;gap:8px;margin-left:8px">
            <span class="muted">Ù…Ø¯Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)</span>
            <input id="minutesInput" type="number" min="1" value="25" />
          </label>
          <button class="btn" id="setBtn">ØªØ¹ÙŠÙŠÙ†</button>
        </div>

        <div class="muted" style="margin-top:10px">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù„Ø¨Ø¯Ø¡/Ø¥ÙŠÙ‚Ø§Ù Ø¨Ø³Ø±Ø¹Ø© (Ù…Ø§ Ù„Ù… ØªÙƒÙ† ØªÙƒØªØ¨ ÙÙŠ Ø­Ù‚Ù„).</div>
      </section>

      <!-- Notes -->
      <section id="notes" class="card view" style="display:none">
        <div class="headline"><h2>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2><div class="muted">ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù…ØªØµÙØ­Ùƒ</div></div>
        <textarea id="noteText" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ù‡Ù†Ø§..."></textarea>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="addNoteBtn" class="btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
          <button id="clearAllNotes" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </div>
        <div id="notesList" style="margin-top:12px"></div>
      </section>
    </main>
  </div>

  <footer>ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© StudyBuddy â€” 2025</footer>

  <!-- ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
  <audio id="alarmAudio" preload="auto"><source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg"></audio>

  <script>
    // ======= Helper: ØªØ­ÙˆÙŠÙ„ Google Drive Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· ØªÙ†Ø²ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± (Ø¥Ù† Ø£Ù…ÙƒÙ†) =======
    function toDirectDriveLink(url){
      if(!url) return url;
      try {
        // Ø¥Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† ØµÙŠØºØ© drive.google.com/file/d/ID/...
        const m = url.match(/\/d\/([a-zA-Z0-9_\-]+)(\/|$)/);
        if(m && m[1]){
          return `https://drive.google.com/uc?export=download&id=${m[1]}`;
        }
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ø§Ø¨Ø· Ù…ÙˆØ¬ÙˆØ¯ Ø¨ØµÙŠØºØ© open?id=ID
        const m2 = url.match(/[?&]id=([a-zA-Z0-9_\-]+)/);
        if(m2 && m2[1]) return `https://drive.google.com/uc?export=download&id=${m2[1]}`;
        // Ù„Ùˆ ÙƒØ§Ù† Ø±Ø§Ø¨Ø· googleusercontent (Ù…Ø¨Ø§Ø´Ø±) Ø§ØªØ±ÙƒÙ‡
        return url;
      } catch(e){ return url; }
    }

    // ======= Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ùˆ localStorage keys =======
    const LS = {
      materials: 'study_materials_v1',
      notes: 'study_notes_v1',
      timer: 'study_timer_v1'
    };

    // Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø§Ù„Ù„ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§) â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø£Ùˆ Ø­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const DEFAULT_MATERIALS = [
      { id:'m1', label:'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ø£Ø­ÙŠØ§Ø¡', url:'https://drive.google.com/file/d/1ennaAbaxjJjvlebpy4z76uJI7-mdDJFH/view?usp=drivesdk' },
      { id:'m2', label:'Ù…Ù„Ø²Ù…Ø© 2', url:'https://drive.google.com/file/d/1JsLBMUzmmMOmPqxH2r6q80q-QyZnT9o8/view?usp=drivesdk' },
      { id:'m3', label:'Ù…Ù„Ø²Ù…Ø© 3', url:'https://drive.google.com/file/d/1olnxoHHGn_3bq_LR9VhV72x2iu3XvdCr/view?usp=drivesdk' },
      { id:'m4', label:'Ù…Ù„Ø²Ù…Ø© 4', url:'https://drive.google.com/file/d/1k1He2EAa4Zpx1QyX6UDqeEyXH1RdGe9L/view?usp=drivesdk' },
      { id:'m5', label:'Ù…Ù„Ø²Ù…Ø© 5', url:'https://drive.google.com/file/d/1NgOeTISLW29IOKoP8esZVNvERPaTmzrR/view?usp=drivesdk' },
      { id:'m6', label:'Ù…Ù„Ø²Ù…Ø© 6', url:'https://drive.google.com/file/d/13ikamFJUb2uIkzDWvXcscvI5Cd_oqoxm/view?usp=drivesdk' },
      { id:'m7', label:'Ù…Ù„Ø²Ù…Ø© 7', url:'https://drive.google.com/file/d/1_ySMvpNNMRNLOtjv0u01MNbDTc1zO4LJ/view?usp=drivesdk' },
      { id:'m8', label:'Ù…Ù„Ø²Ù…Ø© 8', url:'https://drive.google.com/file/d/1hOpg6lkaRpI5AypSGMJNgcg3sVRBK7Hp/view?usp=drivesdk' },
      { id:'m9', label:'Ù…Ù„Ø²Ù…Ø© 9', url:'https://drive.google.com/file/d/1AVVh_tqj711mG8SadiLE03hN-sr4MPJK/view?usp=drivesdk' },
      { id:'m10', label:'Ù…Ù„Ø²Ù…Ø© 10', url:'https://drive.google.com/file/d/1-6ue75fdskBBe8QzAg-281UCmfu8HWOL/view?usp=drivesdk' }
    ];

    // ======= Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© =======
    const menuBtn = document.getElementById('menuBtn');
    const side = document.getElementById('side');
    const navItems = side.querySelectorAll('li[data-view]');
    const views = document.querySelectorAll('.view');

    const materialsListEl = document.getElementById('materialsList');
    const addMaterialBtn = document.getElementById('addMaterialBtn');
    const newLabel = document.getElementById('newLabel');
    const newURL = document.getElementById('newURL');
    const saveMaterialsMetaBtn = document.getElementById('saveMaterialsMeta');
    const reloadStatusBtn = document.getElementById('reloadStatus');
    const clearMaterialsBtn = document.getElementById('clearMaterials');

    // Timer elements
    const timerDisplay = document.getElementById('timerDisplay');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const incBtn = document.getElementById('incBtn');
    const decBtn = document.getElementById('decBtn');
    const minutesInput = document.getElementById('minutesInput');
    const setBtn = document.getElementById('setBtn');
    const alarmAudio = document.getElementById('alarmAudio');

    // Notes elements
    const noteText = document.getElementById('noteText');
    const addNoteBtn = document.getElementById('addNoteBtn');
    const clearAllNotesBtn = document.getElementById('clearAllNotes');
    const notesListDiv = document.getElementById('notesList');

    // State
    let materials = [];
    let notes = [];
    let timerInterval = null;
    let timerSeconds = 25 * 60;
    let isRunning = false;

    // ======= Navigation =======
    function showView(id){
      views.forEach(v => v.classList.toggle('active', v.id === id));
      navItems.forEach(n => n.classList.toggle('active', n.dataset.view === id));
      if(window.innerWidth < 880) side.classList.add('hidden');
    }
    menuBtn.addEventListener('click', ()=> side.classList.toggle('hidden'));
    navItems.forEach(li => li.addEventListener('click', ()=> showView(li.dataset.view)));
    window.showView = showView;

    // ======= Materials management =======
    function loadMaterials(){
      try {
        const raw = localStorage.getItem(LS.materials);
        if(raw){ materials = JSON.parse(raw); return; }
      } catch(e){}
      // fallback to defaults copy
      materials = DEFAULT_MATERIALS.map(m => ({...m}));
    }

    function saveMaterials(){
      try { localStorage.setItem(LS.materials, JSON.stringify(materials)); alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø²Ù…'); } catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸'); }
    }

    function addMaterialFromInputs(){
      const lab = (newLabel.value||'').trim();
      const url = (newURL.value||'').trim();
      if(!lab || !url){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ø²Ù…Ø© ÙˆØ§Ù„Ø±Ø§Ø¨Ø·'); return; }
      const id = 'm'+Date.now();
      materials.push({ id, label: lab, url });
      newLabel.value=''; newURL.value='';
      renderMaterials();
      saveMaterials();
    }

    function clearMaterials(){
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ù„Ø§Ø²Ù…ØŸ')) return;
      materials = [];
      renderMaterials();
      saveMaterials();
    }

    function renderMaterials(){
      materialsListEl.innerHTML = '';
      if(materials.length === 0){
        materialsListEl.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø²Ù… â€” Ø£Ø¶Ù Ù…Ù„Ø²Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ø¹Ù„Ø§Ù‡</div>';
        return;
      }
      materials.forEach((m, idx) => {
        const li = document.createElement('li');
        li.className = 'material-item';
        const safeLabel = escapeHtml(m.label || '');
        const safeURL = escapeHtml(m.url || '');
        li.innerHTML = `
          <div class="material-left">
            <input data-idx="${idx}" class="mat-label" value="${safeLabel}" />
            <div class="material-url" title="${safeURL}">${safeURL}</div>
          </div>
          <div class="material-actions">
            <span class="status" data-idx="${idx}">â€¦</span>
            <button class="small-btn test-btn" data-idx="${idx}">Ø§Ø®ØªØ¨Ø§Ø±</button>
            <button class="btn open-btn" data-idx="${idx}">ÙØªØ­</button>
            <button class="small-btn del-btn" data-idx="${idx}">Ø­Ø°Ù</button>
          </div>
        `;
        materialsListEl.appendChild(li);
      });

      // bind events
      materialsListEl.querySelectorAll('.mat-label').forEach(inp=>{
        inp.addEventListener('input', e=>{
          const i = +e.target.dataset.idx;
          materials[i].label = e.target.value;
        });
      });
      materialsListEl.querySelectorAll('.open-btn').forEach(b=>{
        b.addEventListener('click', e=>{
          const i = +e.dataset.idx;
          const raw = materials[i].url;
          const direct = toDirectDriveLink(raw);
          // open direct link in new tab
          window.open(direct, '_blank');
        });
      });
      materialsListEl.querySelectorAll('.del-btn').forEach(b=>{
        b.addEventListener('click', e=>{
          const i = +e.dataset.idx;
          if(!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø²Ù…Ø©ØŸ')) return;
          materials.splice(i,1);
          renderMaterials();
          saveMaterials();
        });
      });
      materialsListEl.querySelectorAll('.test-btn').forEach(b=>{
        b.addEventListener('click', async e=>{
          const i = +e.dataset.idx;
          const span = materialsListEl.querySelector(`.status[data-idx="${i}"]`);
          span.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦';
          const ok = await testUrl(materials[i].url);
          span.textContent = ok ? 'âœ… Ù…ØªØ§Ø­' : 'âš ï¸ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·';
          span.style.color = ok ? 'green' : '#d16a3a';
        });
      });
      // after render, run quick check for all (non-blocking)
      updateAllStatuses();
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // test URL: try HEAD; if fails due to CORS, return false but allow open
    async function testUrl(url){
      try {
        // If it's drive link, convert to direct download then try fetch
        const direct = toDirectDriveLink(url);
        const r = await fetch(direct, { method:'HEAD' });
        return r && r.ok;
      } catch(e){
        // Some servers block HEAD or CORS â€” fallback: try GET with no-cors (can't read response), treat as unknown => return false
        return false;
      }
    }

    async function updateAllStatuses(){
      const spans = materialsListEl.querySelectorAll('.status');
      spans.forEach(s => s.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦');
      for(let i=0;i<materials.length;i++){
        const ok = await testUrl(materials[i].url);
        const span = materialsListEl.querySelector(`.status[data-idx="${i}"]`);
        if(span){ span.textContent = ok ? 'âœ… Ù…ØªØ§Ø­' : 'âš ï¸ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·'; span.style.color = ok ? 'green' : '#d16a3a'; }
      }
    }

    // ======= Timer logic =======
    function updateTimerDisplay(){
      const m = Math.floor(timerSeconds/60).toString().padStart(2,'0');
      const s = (timerSeconds%60).toString().padStart(2,'0');
      timerDisplay.textContent = `${m}:${s}`;
    }

    function startTimer(){
      if(isRunning) return;
      isRunning = true;
      if(timerSeconds <= 0) timerSeconds = Math.max(1, parseInt(minutesInput.value||25)) * 60;
      timerInterval = setInterval(()=>{
        if(timerSeconds > 0){
          timerSeconds--;
          updateTimerDisplay();
        } else {
          stopTimer();
          try { alarmAudio.currentTime = 0; alarmAudio.play().catch(()=>{}); } catch(e){}
          if('Notification' in window && Notification.permission === 'granted'){
            new Notification('StudyBuddy', { body:'Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©' });
          } else {
            if('Notification' in window && Notification.permission === 'default') Notification.requestPermission().catch(()=>{});
            alert('â° Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©');
          }
        }
      },1000);
      saveTimerState();
    }

    function stopTimer(){
      clearInterval(timerInterval);
      timerInterval = null;
      isRunning = false;
      saveTimerState();
    }

    function pauseTimer(){ stopTimer(); }

    function resetTimer(){
      stopTimer();
      timerSeconds = Math.max(1, parseInt(minutesInput.value||25)) * 60;
      updateTimerDisplay();
      saveTimerState();
    }

    function incMinute(){ timerSeconds += 60; updateTimerDisplay(); saveTimerState(); }
    function decMinute(){ if(timerSeconds > 60) timerSeconds -= 60; updateTimerDisplay(); saveTimerState(); }

    function setSession(){ timerSeconds = Math.max(1, parseInt(minutesInput.value||25)) * 60; updateTimerDisplay(); saveTimerState(); }

    function saveTimerState(){
      try { localStorage.setItem(LS.timer, JSON.stringify({ timerSeconds, isRunning, minutesInput: parseInt(minutesInput.value||25) })); } catch(e){}
    }
    function loadTimerState(){
      try {
        const raw = localStorage.getItem(LS.timer);
        if(!raw) return;
        const o = JSON.parse(raw);
        if(o.timerSeconds||o.timerSeconds===0) timerSeconds = o.timerSeconds;
        if(o.minutesInput) minutesInput.value = o.minutesInput;
        updateTimerDisplay();
        if(o.isRunning) startTimer();
      } catch(e){}
    }

    // ======= Notes =======
    function loadNotes(){
      try {
        const raw = localStorage.getItem(LS.notes);
        notes = raw ? JSON.parse(raw) : [];
      } catch(e){ notes = []; }
      renderNotes();
    }

    function saveNotes(){ try { localStorage.setItem(LS.notes, JSON.stringify(notes)); } catch(e){} }

    function renderNotes(){
      notesListDiv.innerHTML = '';
      if(!notes || notes.length===0){ notesListDiv.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>'; return; }
      notes.slice().reverse().forEach(n=>{
        const el = document.createElement('div');
        el.className = 'notes-list-item';
        el.innerHTML = `<div style="font-size:14px">${escapeHtml(n.text)}</div>
          <div style="margin-top:6px;font-size:12px;color:var(--muted)">${new Date(n.created).toLocaleString()}</div>
          <div style="margin-top:6px"><button class="small-btn del-note" data-id="${n.id}">Ø­Ø°Ù</button></div>`;
        notesListDiv.appendChild(el);
      });
      notesListDiv.querySelectorAll('.del-note').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id = b.dataset.id;
          notes = notes.filter(x=>x.id !== id);
          saveNotes(); renderNotes();
        });
      });
    }

    // ======= Utilities =======
    function uid(prefix='id'){ return prefix + '-' + Date.now() + '-' + Math.floor(Math.random()*1000); }

    // Convert Drive link to direct download (used when opening)
    function toDirectDriveLink(url){
      try {
        if(!url) return url;
        const p = url.trim();
        // match /d/ID/
        const m = p.match(/\/d\/([a-zA-Z0-9_\-]+)(\/|$|\?)/);
        if(m && m[1]) return `https://drive.google.com/uc?export=download&id=${m[1]}`;
        // match ?id=ID
        const m2 = p.match(/[?&]id=([a-zA-Z0-9_\-]+)/);
        if(m2 && m2[1]) return `https://drive.google.com/uc?export=download&id=${m2[1]}`;
        return p;
      } catch(e){ return url; }
    }

    // test url with HEAD (may fail due to CORS)
    async function testUrl(url){
      try {
        const direct = toDirectDriveLink(url);
        const res = await fetch(direct, { method:'HEAD' });
        return res && res.ok;
      } catch(e){
        return false;
      }
    }

    // quick non-blocking check for statuses
    async function updateAllStatuses(){ await updateAllStatusesImpl(); }
    async function updateAllStatusesImpl(){
      const statusEls = materialsListEl.querySelectorAll('.status');
      statusEls.forEach(s => s.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦');
      for(let i=0;i<materials.length;i++){
        try {
          const ok = await testUrl(materials[i].url);
          const span = materialsListEl.querySelector(`.status[data-idx="${i}"]`);
          if(span){ span.textContent = ok ? 'âœ… Ù…ØªØ§Ø­' : 'âš ï¸ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·'; span.style.color = ok ? 'green' : '#d16a3a'; }
        } catch(e){
          const span = materialsListEl.querySelector(`.status[data-idx="${i}"]`);
          if(span){ span.textContent = 'âš ï¸ ØºÙŠØ± Ù…Ø¤ÙƒØ¯'; span.style.color = '#d16a3a'; }
        }
      }
    }

    // ======= Events binding =======
    function bindUI(){
      addMaterialBtn.addEventListener('click', addMaterialFromInputs);
      saveMaterialsMetaBtn.addEventListener('click', saveMaterials);
      reloadStatusBtn.addEventListener('click', ()=> updateAllStatuses());
      clearMaterialsBtn.addEventListener('click', clearMaterials);

      // Timer binds
      startBtn.addEventListener('click', startTimer);
      pauseBtn.addEventListener('click', pauseTimer);
      resetBtn.addEventListener('click', resetTimer);
      incBtn.addEventListener('click', incMinute);
      decBtn.addEventListener('click', decMinute);
      setBtn.addEventListener('click', setSession);

      // Notes binds
      addNoteBtn.addEventListener('click', ()=>{
        const txt = (noteText.value||'').trim();
        if(!txt){ alert('Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©'); return; }
        notes.push({ id: uid('note'), text: txt, created: Date.now() });
        saveNotes(); noteText.value=''; renderNotes(); alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
      });
      clearAllNotesBtn.addEventListener('click', ()=>{
        if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŸ')) return;
        notes = []; saveNotes(); renderNotes();
      });

      // keyboard: space toggles start/pause if not typing
      document.addEventListener('keydown', (e)=>{
        if(e.code === 'Space' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA'){
          if(isRunning) pauseTimer(); else startTimer();
          e.preventDefault();
        }
      });
    }

    // ======= Init =======
    function init(){
      loadMaterials();
      renderMaterials();
      loadNotes();
      loadTimerState();
      updateTimerDisplay();
      bindUI();
      // initial check for statuses (non-blocking)
      updateAllStatuses().catch(()=>{});
      if(window.innerWidth < 880) side.classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
