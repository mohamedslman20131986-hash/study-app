<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b6e4f" />
  <title>StudyBuddy â€” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</title>

  <style>
    /* ---------- Ø³ØªØ§ÙŠÙ„ Ø¹Ø§Ù… (Ù…Ø¶Ù…Ù‘Ù†) ---------- */
    :root{
      --primary:#0b6e4f; --muted:#6b6b6b; --bg:#f6f6f6; --card:#fff;
      --nav-transition: 120ms; /* Ø³Ø±Ø¹Ø© Ø§Ù„ØªÙ†Ù‚Ù„/Ø§Ù„ÙØªØ­ â€” ØºÙŠØ±Ù‡Ø§ Ù„Ùˆ ØªØ­Ø¨ */
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Tahoma,Arial,sans-serif;background:var(--bg);color:#222;direction:rtl}
    .topbar{display:flex;align-items:center;justify-content:space-between;background:var(--primary);color:#fff;padding:12px 16px;position:sticky;top:0;z-index:90}
    .brand{font-size:20px;font-weight:700}
    .icon-btn{background:none;border:0;color:#fff;font-size:20px;cursor:pointer;padding:6px}
    .container{display:flex;min-height:calc(100vh - 56px)}
    /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
    .side{width:300px;background:var(--card);border-left:1px solid #eaeaea;padding:12px;box-shadow:-6px 0 18px rgba(0,0,0,0.05);transition:transform var(--nav-transition) ease;transform:translateX(0)}
    .side.hidden{transform:translateX(110%)}
    .side ul{list-style:none;padding:0;margin:0}
    .side li{padding:10px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:10px}
    .side li.active,.side li:hover{background:var(--primary);color:#fff}
    .side .note{font-size:12px;color:var(--muted);margin-top:14px;text-align:center}
    /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
    main{flex:1;padding:18px;max-width:1100px;margin:0 auto}
    .card{background:var(--card);border-radius:10px;padding:18px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
    .summary-grid{display:flex;gap:18px;justify-content:space-around;text-align:center;flex-wrap:wrap}
    .summary-item .num{font-size:28px;color:var(--primary);font-weight:700}
    .list{list-style:disc;padding-inline-start:20px;margin:0}
    a.link{color:#1a0dab;text-decoration:underline}
    .btn{border:0;padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{background:#f0f0f0}
    textarea{width:100%;min-height:100px;padding:10px;border-radius:8px;border:1px solid #eee;font-family:inherit}
    .flashcard{min-height:140px;border-radius:8px;background:#fafafa;border:1px solid #eee;padding:18px;display:flex;align-items:center;justify-content:center;font-size:18px;text-align:center}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .timer-display{font-size:44px;font-weight:700;margin:8px 0}
    .muted{color:var(--muted);font-size:13px}
    footer{padding:14px;text-align:center;color:var(--muted);font-size:13px}

    /* responsive */
    @media (max-width:880px){
      .side{position:fixed;top:56px;right:0;height:calc(100% - 56px);z-index:95}
      .container{flex-direction:column}
      main{padding:12px}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <button id="menuBtn" class="icon-btn" aria-label="Ù‚Ø§Ø¦Ù…Ø©">â˜°</button>
    <div class="brand">StudyBuddy ğŸ“š</div>
    <button id="addBtn" class="icon-btn" title="Ø£Ø¶Ù">ï¼‹</button>
  </header>

  <div class="container">
    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <nav id="side" class="side hidden" aria-hidden="true">
      <ul>
        <li data-view="dashboard" class="active">Ø§Ù„Ù…Ù„Ø®Øµ</li>
        <li data-view="books">Ø§Ù„Ù…Ù„Ø§Ø²Ù… ğŸ“</li>
        <li data-view="subjects">Ø§Ù„Ù…ÙˆØ§Ø¯ ğŸ“š</li>
        <li data-view="tasks">Ø§Ù„Ù…Ù‡Ø§Ù… âœ…</li>
        <li data-view="flashcards">Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© ğŸƒ</li>
        <li data-view="timer">Ø§Ù„Ù…Ø¤Ù‚Øª â±</li>
        <li data-view="notes">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ğŸ“</li>
        <li data-view="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âš™ï¸</li>
      </ul>
      <div class="note">StudyBuddy â€” ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„</div>
    </nav>

    <main id="main">
      <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù„Ø®Øµ -->
      <section id="dashboard" class="view card">
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h2>
        <p class="muted">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹: Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯ØŒ Ø§Ù„Ù…Ù‡Ø§Ù…ØŒ ÙˆØ¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©.</p>
        <div class="summary-grid" style="margin-top:12px">
          <div class="summary-item"><div class="num" id="countSubjects">0</div><div>Ø§Ù„Ù…ÙˆØ§Ø¯</div></div>
          <div class="summary-item"><div class="num" id="countTasks">0</div><div>Ø§Ù„Ù…Ù‡Ø§Ù…</div></div>
          <div class="summary-item"><div class="num" id="countFlash">0</div><div>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</div></div>
        </div>
      </section>

      <!-- Ø§Ù„Ù…Ù„Ø§Ø²Ù… -->
      <section id="books" class="view card" style="display:none">
        <h2>Ø§Ù„Ù…Ù„Ø§Ø²Ù…</h2>
        <p class="muted">Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª PDF. ØªØ£ÙƒØ¯ ØªØ±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ <code>/pdfs/</code> Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª.</p>
        <ul id="booksList" class="list" style="margin-top:10px"></ul>
      </section>

      <!-- Ø§Ù„Ù…ÙˆØ§Ø¯ -->
      <section id="subjects" class="view card" style="display:none">
        <h2>Ø§Ù„Ù…ÙˆØ§Ø¯</h2>
        <p><button id="addSubjectBtn" class="btn ghost">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button></p>
        <ul id="subjectsList" class="list" style="margin-top:8px"></ul>
      </section>

      <!-- Ø§Ù„Ù…Ù‡Ø§Ù… -->
      <section id="tasks" class="view card" style="display:none">
        <h2>Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
        <p><button id="addTaskBtn" class="btn ghost">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button></p>
        <ul id="tasksList" class="list" style="margin-top:8px"></ul>
      </section>

      <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© -->
      <section id="flashcards" class="view card" style="display:none">
        <h2>Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</h2>
        <div id="flashCard" class="flashcard">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª â€” Ø£Ø¶Ù Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø¨Ø¯Ø¡</div>
        <div class="controls">
          <button id="prevFlash" class="btn ghost">â—€</button>
          <button id="flipFlash" class="btn ghost">Ù‚Ù„Ø¨</button>
          <button id="nextFlash" class="btn ghost">â–¶</button>
          <button id="addFlash" class="btn ghost">Ø£Ø¶Ù Ø¨Ø·Ø§Ù‚Ø©</button>
        </div>
      </section>

      <!-- Ø§Ù„Ù…Ø¤Ù‚Øª -->
      <section id="timer" class="view card" style="display:none">
        <h2>Ù…Ø¤Ù‚Øª Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ</h2>
        <div id="timerDisplay" class="timer-display">25:00</div>
        <div class="controls">
          <label>Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯Ù‚Ø§Ø¦Ù‚): <input id="sessionMinutes" type="number" min="1" value="25" style="width:80px;margin-right:8px"></label>
        </div>
        <div class="controls" style="margin-top:10px">
          <button id="startTimer" class="btn primary">Ø§Ø¨Ø¯Ø£</button>
          <button id="pauseTimer" class="btn ghost">Ø¥ÙŠÙ‚Ø§Ù</button>
          <button id="resetTimer" class="btn ghost">Ø¥Ø¹Ø§Ø¯Ø©</button>
        </div>
      </section>

      <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
      <section id="notes" class="view card" style="display:none">
        <h2>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
        <textarea id="noteText" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ù‡Ù†Ø§..."></textarea>
        <div class="controls" style="margin-top:10px">
          <button id="saveNote" class="btn primary">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
          <button id="clearNotes" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </div>
        <ul id="notesList" class="list" style="margin-top:10px"></ul>
      </section>

      <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
      <section id="settings" class="view card" style="display:none">
        <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
        <div style="margin-bottom:10px">
          <label><input id="toggleDark" type="checkbox"> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</label>
        </div>
        <div class="controls">
          <button id="exportData" class="btn ghost">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
          <button id="importData" class="btn ghost">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <input id="fileInput" type="file" accept=".json" style="display:none">
        </div>
      </section>
    </main>
  </div>

  <footer>ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© StudyBuddy â€” 2025</footer>

  <script>
  /************************************************************************
   IndexedDB wrapper (Ø¹Ù†Ø§ÙŠØ©: Ø³Ø·Ø± Ø³Ø·Ø±) â€” ÙŠÙˆÙØ± getAll, put, del, openDB
  *************************************************************************/
  const STUDYDB = (() => {
    const dbName = 'studybuddyDB';
    const version = 1;
    let db = null;

    function openDB(){
      return new Promise((resolve, reject) => {
        try {
          const req = indexedDB.open(dbName, version);
          req.onupgradeneeded = e => {
            db = e.target.result;
            if(!db.objectStoreNames.contains('subjects')) db.createObjectStore('subjects', { keyPath: 'id' });
            if(!db.objectStoreNames.contains('tasks')) db.createObjectStore('tasks', { keyPath: 'id' });
            if(!db.objectStoreNames.contains('flash')) db.createObjectStore('flash', { keyPath: 'id' });
            if(!db.objectStoreNames.contains('notes')) db.createObjectStore('notes', { keyPath: 'id' });
          };
          req.onsuccess = e => { db = e.target.result; resolve(); };
          req.onerror = e => reject(e);
        } catch(err) { reject(err); }
      });
    }

    function tx(store, mode='readonly'){
      if(!db) throw new Error('Database not opened');
      return db.transaction(store, mode).objectStore(store);
    }

    function getAll(store){
      return new Promise((resolve, reject) => {
        try {
          const r = tx(store).getAll();
          r.onsuccess = () => resolve(r.result || []);
          r.onerror = () => reject(r.error || new Error('getAll error'));
        } catch(err) { reject(err); }
      });
    }

    function put(store, value){
      return new Promise((resolve, reject) => {
        try {
          const r = tx(store, 'readwrite').put(value);
          r.onsuccess = () => resolve(value);
          r.onerror = () => reject(r.error || new Error('put error'));
        } catch(err) { reject(err); }
      });
    }

    function del(store, key){
      return new Promise((resolve, reject) => {
        try {
          const r = tx(store, 'readwrite').delete(key);
          r.onsuccess = () => resolve();
          r.onerror = () => reject(r.error || new Error('delete error'));
        } catch(err) { reject(err); }
      });
    }

    return { openDB, getAll, put, del };
  })();


  /************************************************************************
   Main App â€” Ø¯Ù‚Ù‘Ù‚Øª Ø¨Ù‡ Ø³Ø·Ø± Ø³Ø·Ø±ØŒ Ø§Ù„ØªÙ†Ù‚Ù‘Ù„ ÙÙˆØ±ÙŠ ÙˆÙØ¹Ø§Ù„ (showView Ø³Ø±ÙŠØ¹)
  *************************************************************************/
  const App = (() => {
    // short helpers
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const esc = s => s ? String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[c])) : '';

    // state
    const state = { subjects: [], tasks: [], flash: [], notes: [] };
    let timerInterval = null;
    let timerSeconds = 25*60;
    let flashIndex = 0;
    let flashShowingBack = false;

    // DOM refs
    const menuBtn = $('#menuBtn'), side = $('#side'), addBtn = $('#addBtn');
    const views = $$('.view');
    const countSubjects = $('#countSubjects'), countTasks = $('#countTasks'), countFlash = $('#countFlash');
    const subjectsList = $('#subjectsList'), tasksList = $('#tasksList'), notesList = $('#notesList'), booksList = $('#booksList');
    const flashCard = $('#flashCard'), prevFlash = $('#prevFlash'), nextFlash = $('#nextFlash'), flipFlash = $('#flipFlash'), addFlash = $('#addFlash');
    const timerDisplay = $('#timerDisplay'), startTimer = $('#startTimer'), pauseTimer = $('#pauseTimer'), resetTimer = $('#resetTimer'), sessionMinutes = $('#sessionMinutes');
    const noteText = $('#noteText'), saveNote = $('#saveNote'), clearNotes = $('#clearNotes');
    const addSubjectBtn = $('#addSubjectBtn'), addTaskBtn = $('#addTaskBtn');
    const exportBtn = $('#exportData'), importBtn = $('#importData'), fileInput = $('#fileInput'), toggleDark = $('#toggleDark');

    // default books â€” ØºÙŠÙ‘Ø± Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù„Ùˆ Ù„Ø§Ø²Ù…
    const books = [
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', file: 'pdfs/math.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡', file: 'pdfs/physics.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡', file: 'pdfs/chemistry.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø¬Ø²Ø¡1)', file: 'pdfs/arabic1.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø¬Ø²Ø¡2)', file: 'pdfs/arabic2.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ', file: 'pdfs/english.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ø§Ø³Ù„Ø§Ù…ÙŠØ©', file: 'pdfs/islamic.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ø§Ø­ÙŠØ§Ø¡', file: 'pdfs/biology.pdf' },
      { name: 'Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª', file: 'pdfs/social.pdf' }
    ];

    // init app
    async function init(){
      try {
        await STUDYDB.openDB();
      } catch(e){
        console.warn('IndexedDB not available, using fallback', e);
      }
      await loadAll();
      seedSubjectsIfEmpty();
      bindEvents();
      renderBooks();
      renderAll();
      showView('dashboard');
      updateTimerDisplay();
      // register service worker if available (optional)
      if('serviceWorker' in navigator){
        try { navigator.serviceWorker.register('sw.js'); } catch(e){}
      }
    }

    // load from DB (with fallback localStorage)
    async function loadAll(){
      try {
        state.subjects = await STUDYDB.getAll('subjects').catch(()=> []);
        state.tasks = await STUDYDB.getAll('tasks').catch(()=> []);
        state.flash = await STUDYDB.getAll('flash').catch(()=> []);
        state.notes = await STUDYDB.getAll('notes').catch(()=> []);
      } catch(e){
        const raw = localStorage.getItem('studybuddy_backup');
        if(raw){
          try {
            const o = JSON.parse(raw);
            state.subjects = o.subjects || [];
            state.tasks = o.tasks || [];
            state.flash = o.flash || [];
            state.notes = o.notes || [];
          } catch(err){}
        }
      }
    }

    // fallback save
    function saveFallback(){
      try { localStorage.setItem('studybuddy_backup', JSON.stringify(state)); } catch(e){}
    }

    // seed subjects if empty
    async function seedSubjectsIfEmpty(){
      if(state.subjects.length === 0){
        const list = ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡','Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡','Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©','Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ','Ø§Ù„Ø§Ø­ÙŠØ§Ø¡','Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª','Ø§Ù„Ø§Ø³Ù„Ø§Ù…ÙŠØ©'];
        for(let i=0;i<list.length;i++){
          const id = 'sub-' + Date.now() + '-' + i;
          const obj = { id, title: list[i], desc: '' };
          try { await STUDYDB.put('subjects', obj); } catch(e){}
          state.subjects.push(obj);
        }
        saveFallback();
      }
    }

    // binding UI
    function bindEvents(){
      // menu toggle
      menuBtn.addEventListener('click', ()=> side.classList.toggle('hidden'));
      // side navigation (fast)
      $$('.side li').forEach(li => li.addEventListener('click', e=>{
        const v = e.currentTarget.dataset.view;
        if(!v) return;
        showView(v);
        $$('.side li').forEach(x=>x.classList.remove('active'));
        e.currentTarget.classList.add('active');
      }));

      // quick add (top + button)
      addBtn.addEventListener('click', ()=> {
        // ÙŠÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø³Ø±ÙŠØ¹)
        showView('subjects'); activateNav('subjects');
      });

      addSubjectBtn && addSubjectBtn.addEventListener('click', onAddSubject);
      addTaskBtn && addTaskBtn.addEventListener('click', onAddTask);

      // timer controls
      startTimer && startTimer.addEventListener('click', startPomodoro);
      pauseTimer && pauseTimer.addEventListener('click', pausePomodoro);
      resetTimer && resetTimer.addEventListener('click', ()=> {
        stopPomodoro(); const m = Math.max(1, parseInt(sessionMinutes.value||25)); timerSeconds = m*60; updateTimerDisplay();
      });
      sessionMinutes && sessionMinutes.addEventListener('change', ()=> { const m = Math.max(1, parseInt(sessionMinutes.value||25)); timerSeconds = m*60; updateTimerDisplay(); });

      // flash controls
      prevFlash && prevFlash.addEventListener('click', ()=> { if(state.flash.length===0) return; flashIndex = (flashIndex-1+state.flash.length)%state.flash.length; flashShowingBack=false; renderFlash(); });
      nextFlash && nextFlash.addEventListener('click', ()=> { if(state.flash.length===0) return; flashIndex = (flashIndex+1)%state.flash.length; flashShowingBack=false; renderFlash(); });
      flipFlash && flipFlash.addEventListener('click', ()=> { flashShowingBack = !flashShowingBack; renderFlash(); });
      addFlash && addFlash.addEventListener('click', onAddFlash);

      // notes
      saveNote && saveNote.addEventListener('click', async ()=>{
        const text = (noteText.value||'').trim();
        if(!text) return alert('Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
        const id = 'note-'+Date.now();
        const obj = { id, text, created: Date.now() };
        try { await STUDYDB.put('notes', obj); } catch(e){}
        state.notes.push(obj);
        noteText.value = '';
        renderNotes(); saveFallback();
      });
      clearNotes && clearNotes.addEventListener('click', async ()=>{
        if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŸ')) return;
        for(const n of state.notes) try{ await STUDYDB.del('notes', n.id); } catch(e){}
        state.notes = []; renderNotes(); saveFallback();
      });

      // import/export
      exportBtn && exportBtn.addEventListener('click', exportData);
      importBtn && importBtn.addEventListener('click', ()=> fileInput.click());
      fileInput && fileInput.addEventListener('change', importData);

      // dark mode toggle
      toggleDark && toggleDark.addEventListener('change', ()=> document.documentElement.classList.toggle('dark', toggleDark.checked));
    }

    // helper toggle active nav
    function activateNav(name){
      $$('.side li').forEach(li=> li.classList.toggle('active', li.dataset.view === name));
    }

    // show view quickly
    function showView(id){
      views.forEach(v => {
        if(v.id === id) { v.style.display = ''; } else { v.style.display = 'none'; }
      });
      // hide side on mobile for quicker UX
      if(window.innerWidth < 880) side.classList.add('hidden');
    }

    /********** Subjects **********/
    async function onAddSubject(){
      const title = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:');
      if(!title) return;
      const id = 'sub-'+Date.now();
      const obj = { id, title: title.trim(), desc: '' };
      try { await STUDYDB.put('subjects', obj); } catch(e){}
      state.subjects.push(obj);
      renderSubjects(); updateCounts(); saveFallback();
    }

    function renderSubjects(){
      if(!subjectsList) return;
      subjectsList.innerHTML = '';
      if(state.subjects.length === 0){ subjectsList.innerHTML = '<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯</li>'; return; }
      state.subjects.forEach(s => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${esc(s.title)}</strong> <button class="btn ghost del-sub" data-id="${s.id}" style="margin-right:8px">Ø­Ø°Ù</button>`;
        subjectsList.appendChild(li);
      });
      // attach delete handlers
      $$('.del-sub').forEach(b => b.addEventListener('click', async e=>{
        const id = e.currentTarget.dataset.id;
        if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) return;
        try { await STUDYDB.del('subjects', id); } catch(e){}
        state.subjects = state.subjects.filter(x => x.id !== id);
        renderSubjects(); updateCounts(); saveFallback();
      }));
    }

    /********** Tasks **********/
    async function onAddTask(){
      const title = prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©:');
      if(!title) return;
      const subject = prompt('Ø§Ù„Ù…Ø§Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):') || '';
      const due = prompt('ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (Ù…Ø«Ø§Ù„: 2025-09-30T14:30) â€” Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯') || null;
      const id = 'task-' + Date.now();
      const obj = { id, title: title.trim(), subject: (subject||'').trim(), due: due || null, done: false };
      try { await STUDYDB.put('tasks', obj); } catch(e){}
      state.tasks.push(obj);
      renderTasks(); updateCounts(); saveFallback();
    }

    function renderTasks(){
      if(!tasksList) return;
      tasksList.innerHTML = '';
      if(state.tasks.length === 0){ tasksList.innerHTML = '<li>Ù„Ø§ Ù…Ù‡Ø§Ù…</li>'; return; }
      state.tasks.forEach(t => {
        const dueText = t.due ? new Date(t.due).toLocaleString() : 'Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¹Ø¯';
        const li = document.createElement('li');
        li.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div><strong>${esc(t.title)}</strong></div>
            <div class="muted">${esc(t.subject||'')} â€¢ ${esc(dueText)}</div>
          </div>
          <div>
            <button class="btn ghost doneBtn" data-id="${t.id}">${t.done ? 'âœ“' : 'â—‹'}</button>
            <button class="btn ghost delTask" data-id="${t.id}">Ø­Ø°Ù</button>
          </div>
        </div>`;
        tasksList.appendChild(li);
      });
      // handlers
      $$('.doneBtn').forEach(b => b.addEventListener('click', async e=>{
        const id = e.currentTarget.dataset.id;
        const t = state.tasks.find(x=>x.id===id); if(!t) return;
        t.done = !t.done;
        try { await STUDYDB.put('tasks', t); } catch(e){}
        renderTasks(); saveFallback();
      }));
      $$('.delTask').forEach(b => b.addEventListener('click', async e=>{
        const id = e.currentTarget.dataset.id;
        if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
        try { await STUDYDB.del('tasks', id); } catch(e){}
        state.tasks = state.tasks.filter(x=>x.id!==id);
        renderTasks(); updateCounts(); saveFallback();
      }));
    }

    /********** Flashcards **********/
    async function onAddFlash(){
      const front = prompt('Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø§Ù„Ø³Ø¤Ø§Ù„):');
      if(!front) return;
      const back = prompt('Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©):') || '';
      const id = 'flash-' + Date.now();
      const obj = { id, front: front.trim(), back: back.trim() };
      try { await STUDYDB.put('flash', obj); } catch(e){}
      state.flash.push(obj);
      renderFlash(); updateCounts(); saveFallback();
    }

    function renderFlash(){
      if(!flashCard) return;
      if(state.flash.length === 0){ flashCard.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª â€” Ø£Ø¶Ù Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø¨Ø¯Ø¡'; return; }
      if(flashIndex >= state.flash.length) flashIndex = 0;
      const card = state.flash[flashIndex];
      flashCard.textContent = flashShowingBack ? card.back : card.front;
    }

    /********** Notes **********/
    function renderNotes(){
      if(!notesList) return;
      notesList.innerHTML = '';
      if(state.notes.length === 0){ notesList.innerHTML = '<li>Ù„Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</li>'; return; }
      state.notes.slice().reverse().forEach(n=>{
        const li = document.createElement('li');
        li.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div>${esc(n.text)}</div>
            <div class="muted">${new Date(n.created).toLocaleString()}</div>
          </div>
          <div><button class="btn ghost delNote" data-id="${n.id}">Ø­Ø°Ù</button></div>
        </div>`;
        notesList.appendChild(li);
      });
      $$('.delNote').forEach(b => b.addEventListener('click', async e=>{
        const id = e.currentTarget.dataset.id;
        if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ')) return;
        try { await STUDYDB.del('notes', id); } catch(e){}
        state.notes = state.notes.filter(x=>x.id!==id);
        renderNotes(); saveFallback();
      }));
    }

    /********** Books (Ø§Ù„Ù…Ù„Ø§Ø²Ù…) **********/
    function renderBooks(){
      if(!booksList) return;
      booksList.innerHTML = '';
      books.forEach(b => {
        const li = document.createElement('li');
        li.innerHTML = `<a class="link" href="${b.file}" target="_blank" rel="noopener">${esc(b.name)}</a>`;
        booksList.appendChild(li);
      });
    }

    /********** Timer **********/
    function updateTimerDisplay(){
      const m = Math.floor(timerSeconds/60).toString().padStart(2,'0');
      const s = (timerSeconds%60).toString().padStart(2,'0');
      if(timerDisplay) timerDisplay.textContent = `${m}:${s}`;
    }
    function startPomodoro(){
      if(timerInterval) return;
      const minutes = Math.max(1, parseInt(sessionMinutes.value || 25));
      timerSeconds = minutes * 60;
      updateTimerDisplay();
      timerInterval = setInterval(()=>{
        if(timerSeconds <= 0){ stopPomodoro(); notifyFinish(); return; }
        timerSeconds--; updateTimerDisplay();
      }, 1000);
    }
    function pausePomodoro(){ stopPomodoro(); }
    function stopPomodoro(){ clearInterval(timerInterval); timerInterval = null; }
    function notifyFinish(){
      try {
        if('Notification' in window && Notification.permission === 'granted'){
          new Notification('StudyBuddy', { body: 'Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©' });
        } else {
          alert('Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©');
        }
      } catch(e){ alert('Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©'); }
    }

    /********** Export / Import **********/
    async function exportData(){
      try {
        const payload = {
          subjects: await STUDYDB.getAll('subjects').catch(()=> state.subjects),
          tasks: await STUDYDB.getAll('tasks').catch(()=> state.tasks),
          flash: await STUDYDB.getAll('flash').catch(()=> state.flash),
          notes: await STUDYDB.getAll('notes').catch(()=> state.notes)
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'studybuddy-export.json'; a.click(); URL.revokeObjectURL(url);
      } catch(e){ alert('ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±'); console.error(e); }
    }

    async function importData(){
      const file = fileInput.files && fileInput.files[0];
      if(!file) return;
      try {
        const txt = await file.text();
        const data = JSON.parse(txt);
        if(Array.isArray(data.subjects)) for(const s of data.subjects) try{ await STUDYDB.put('subjects', s); }catch(e){}
        if(Array.isArray(data.tasks)) for(const t of data.tasks) try{ await STUDYDB.put('tasks', t); }catch(e){}
        if(Array.isArray(data.flash)) for(const f of data.flash) try{ await STUDYDB.put('flash', f); }catch(e){}
        if(Array.isArray(data.notes)) for(const n of data.notes) try{ await STUDYDB.put('notes', n); }catch(e){}
        await loadAll(); renderAll(); alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      } catch(e){ alert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù'); console.error(e); }
    }

    /********** utilities **********/
    function updateCounts(){
      if(countSubjects) countSubjects.textContent = state.subjects.length;
      if(countTasks) countTasks.textContent = state.tasks.length;
      if(countFlash) countFlash.textContent = state.flash.length;
    }
    function renderAll(){ renderSubjects(); renderTasks(); renderFlash(); renderNotes(); updateCounts(); }

    // return init
    return { init };
  })();


  // start app
  document.addEventListener('DOMContentLoaded', () => {
    App.init().catch(e => {
      console.error('App init error', e);
      alert('ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: ' + (e && e.message ? e.message : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
    });
  });

  </script>
</body>
</html>
